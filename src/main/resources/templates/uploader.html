<!DOCTYPE html>

<!--/* Note the xmlns:* here are completely optional and only meant to     */-->
<!--/* avoid IDEs from complaining about tags/attributes they may not know */-->
<html xmlns:th="http://www.thymeleaf.org" xmlns:score="http://thymeleafexamples">

<head>
    <title>文件导入</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>

    <link href="/static/css/bootstrap.min.css"
          rel="stylesheet" type="text/css" />
    <link href="/static/css/font-awesome.min.css"
          rel="stylesheet" type="text/css" />
    <link href="/static/css/bootstrap-table.css"
          rel="stylesheet" type="text/css" />
    <link href="/static/css/daterangepicker.css"
          rel="stylesheet" type="text/css" />
    <script type="application/javascript" src="/static/js/jquery.min.js"></script>
    <script type="application/javascript" src="/static/js/bootstrap_table/bootstrap-table.js"></script>
    <script type="application/javascript" src="/static/js/bootstrap_table/locale/bootstrap-table-zh-CN.js"></script>
    <script type="application/javascript" src="/static/js/bootstrap-daterangepicker/moment.js"></script>
    <script type="application/javascript" src="/static/js/bootstrap-daterangepicker/daterangepicker.js"></script>

    <style>
        .my-input{
            position: relative;
        }
        .my-input i {
            position: absolute;
            bottom: 10px;
            right: 14px;
            top: auto;
            cursor: pointer;
        }

    </style>
</head>

<body>
    <div class="container-fluid" style="margin-top: 40px;">
        <div class="row">
            <div class="col-sm-4">
                <form class="form-horizontal" method="POST" action="/upload" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="table" class="col-sm-2 control-label">表名</label>
                        <div class="col-sm-5">
                            <input type="text" class="form-control" id="table" name="table" placeholder="表名" />
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-5">
                            <div class="checkbox">
                                <label>
                                    <input type="checkbox" name="validateIDCard" id="validateIDCard" value="true"/> 开启身份证验证
                                </label>
                            </div>
                        </div>
                    </div>
                    <div id="idcardColumnsForm" class="form-group" for="validateIDCard" style="display: none;">
                        <label for="idcardColumns" class="col-sm-2 control-label">身份证列号</label>
                        <div class="col-sm-5">
                            <input type="text" class="form-control" name="idcardColumns" id="idcardColumns" placeholder="身份证列号" />
                            <span id="helpBlock2" class="help-block">以1位起始序列,多个列以逗号进行分隔</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="exampleInputFile" class="col-sm-2 control-label">上传文件</label>
                        <div class="col-sm-5">
                            <input type="file" name="file" multiple="multiple" id="exampleInputFile"/>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-10">
                            <button type="submit" class="btn btn-default">Submit</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="col-sm-8">
                <h4>导入历史记录</h4>
                <div class="form-inline">
                    <div class="btn-group">文件名：</div>
                    <input type="text" id="fileName" name="date" style="width: 130px"
                           class="form-control" value="" />
                    <div class="form-group">
                        &nbsp;选择日期
                    </div>
                    <div class="form-group" id="divDate">
                        <div class="input-prepend my-input" style="width: 210px" name="selDaysDiv" id="selDaysDiv">
                            <input type="text" readonly="" name="selDays" id="selDays" style="width: 210px" class="form-control" value="" />
                            <i class="glyphicon glyphicon-calendar fa fa-calendar"></i>
                        </div>
                    </div>
                    <div class="form-group">
                        <button id="btnSearch" class="btn btn-success" type="button">
                            <i class="fa fa-search"></i>&nbsp;&nbsp;查 询
                        </button>
                    </div>
                </div>
                <div class="table-responsive" id="static_table" style="margin-top: 10px;min-height:540px;">
                    <table id="his_table">
                    </table>
                </div>
            </div>
        </div>
    </div>


</body>

<script th:inline="javascript">
    /*<![CDATA[*/
    var curDate = new Date(),
        pre7Date = new Date(curDate.getTime() - 6 * 24 * 3600 * 1000);
        timeSeparator = '~';

    $(function(){
        var $idcardColumnsForm = $('#idcardColumnsForm'),
            $table = $('#his_table');
        $('#validateIDCard').click(function(){
            if(this.checked){
                $idcardColumnsForm.show();
            }else{
                $idcardColumnsForm.hide();
            }
        });

        $('#btnSearch').click(function(){
            $table.bootstrapTable('refresh');
        });

        //初始化时间
        $('#selDaysDiv').daterangepicker(
            {
                "opens": this.opens,
                "startDate" : curDate,
                "endDate": curDate,
                separator : timeSeparator,
                dateLimit: { days: 31 }
            }
        );
        $('#selDays').val(pre7Date.Format("yyyy-MM-dd") + '~' + curDate.Format("yyyy-MM-dd"));

        initTable();

        function initTable(){
            $table.bootstrapTable({
                height: 500,
                url: '/fileImportInfos',
                sidePagination: "server",
                dataType: "json",
                /*  silentSort: true, */
                cache: false,
                sortName: 'factory_id',
                pagination: true,
                pageSize: 10,
                pageList: [10,20,50],
                /* sortSide: 'client', */
                queryParams: function(params){
                    var postData = getPostData();
                    params = $.extend(params,postData);
                    return params;
                },
                columns: [
                    {
                        title: '序号',
                        field: 'state',
                        align: 'center',
                        valign: 'middle',
                        width:'30',
                        formatter: function operateFormatter(value, row, index) {
                            var options = $table.bootstrapTable('getOptions');
                            var page = options.pageNumber,
                                perRows = options.pageSize;
                            return (page - 1) * perRows + index + 1;
                        }
                    }, {
                        title: '表名',
                        field: 'tableName',
                        align: 'center',
                        valign: 'middle',
                        width: '60'
                    },{
                        title: '文件名',
                        field: 'fileName',
                        align: 'center',
                        valign: 'middle',
                        width:'100'
                    },{
                        title: '导入时间',
                        field: 'jobStartTime',
                        align: 'center',
                        valign: 'middle',
                        width:'100',
                        formatter: function (value, row, index) {
                            return formatMill(value,'yyyy-MM-dd hh:mm:ss');
                        }
                    },{
                        title: '导入结束时间',
                        field: 'jobEndTime',
                        align: 'center',
                        valign: 'middle',
                        width:'100',
                        formatter: function (value, row, index) {
                            return formatMill(value,'yyyy-MM-dd hh:mm:ss');
                        }
                    },{
                        title: '读取数(条)',
                        field: 'readCount',
                        align: 'center',
                        valign: 'middle',
                        width:'50',
                        formatter: function (value, row, index) {
                            return formatNum(value);
                        }
                    },
                    {
                        title: '写入数(条)',
                        field: 'writeCount',
                        align: 'center',
                        valign: 'middle',
                        width:'50',
                        formatter: function (value, row, index) {
                            return formatNum(value);
                        }
                    },{
                        title: '过滤数(条)',
                        field: 'filterCount',
                        align: 'center',
                        valign: 'middle',
                        width:'50',
                        formatter: function (value, row, index) {
                            return formatNum(value);
                        }
                    },{
                        title: '异常信息',
                        field: 'errorMsg',
                        align: 'center',
                        valign: 'middle',
                        width:'100',
                    },{
                        title: '执行结果',
                        field: 'status',
                        align: 'center',
                        valign: 'middle',
                        width:'50'
                    }
                ]
            }).on('sort.bs.table', function (name,order) {
                //console.log('sortinfo:' + name + ',' + order);
            }).on('post-body.bs.table',function(){

            }).on('load-success.bs.table',function(data){

            });
        }

        function getPostData(){
            var days = $.trim($('#selDays').val());
            var startDay = null,endDay = null;
            if(days){
                var dayAry = days.split(timeSeparator);
                startDay = dayAry[0];
                endDay = dayAry[1];
            }

            var postData = {
                startTime: startDay,
                endTime: endDay,
                fileName: $.trim($('#fileName').val())
            };

            return postData;
        }

        function formatNum(num){
            return num == null ? '-' : num;
        }

        function formatMill(mill,pattern){
            if(!mill){
                return '-';
            }

            var date = new Date();
            date.setTime(mill);

            return date.Format(pattern);
        }


    });

    // 对Date的扩展，将 Date 转化为指定格式的String
    // 月(M)、日(d)、小时(h)、分(m)、秒(s)、季度(q) 可以用 1-2 个占位符，
    // 年(y)可以用 1-4 个占位符，毫秒(S)只能用 1 个占位符(是 1-3 位的数字)
    // 例子：
    // (new Date()).Format("yyyy-MM-dd hh:mm:ss.S") ==> 2006-07-02 08:09:04.423
    // (new Date()).Format("yyyy-M-d h:m:s.S") ==> 2006-7-2 8:9:4.18
    Date.prototype.Format = function(fmt) { // author: meizz
        var o = {
            "M+" : this.getMonth() + 1, // 月份
            "d+" : this.getDate(), // 日
            "h+" : this.getHours(), // 小时
            "m+" : this.getMinutes(), // 分
            "s+" : this.getSeconds(), // 秒
            "q+" : Math.floor((this.getMonth() + 3) / 3), // 季度
            "S" : this.getMilliseconds() // 毫秒
        };
        if (/(y+)/.test(fmt))
            fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
        for ( var k in o)
            if (new RegExp("(" + k + ")").test(fmt))
                fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
        return fmt;
    };

    /*]]>*/
</script>

</html>